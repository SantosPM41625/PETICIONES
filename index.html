<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento Peticiones</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        table {
            width: 90%;
            margin: 0 auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        th {
            background-color: #f4f4f4;
        }
        .retrasado {
            color: red;
            font-weight: bold;
        }
        .a-tiempo {
            color: green;
        }
        .form-container {
            margin-bottom: 20px;
        }
        .reloj {
            font-size: 40px;
            font-weight: bold;
        }
        .fecha {
            font-size: 18px;
            margin-top: 5px;
            color: #555;
        }
    </style>
    <!-- Firebase App (modular SDK) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBOmCL8TeixQT0yWufFPIuC4mE-HbHoJLY",
            authDomain: "seguimiento-34984.firebaseapp.com",
            databaseURL: "https://seguimiento-34984-default-rtdb.firebaseio.com",
            projectId: "seguimiento-34984",
            storageBucket: "seguimiento-34984.appspot.com",
            messagingSenderId: "686867238078",
            appId: "1:686867238078:web:ec42b7bc56ec330be162ef",
            measurementId: "G-BTXWQ6XLFE"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Referencia a la base de datos
        const peticionesRef = ref(db, "peticiones");

        let peticiones = [];

        // Escuchar cambios en la base de datos y actualizar la tabla
        onValue(peticionesRef, (snapshot) => {
            peticiones = [];
            snapshot.forEach((childSnapshot) => {
                const peticion = { id: childSnapshot.key, ...childSnapshot.val() };
                peticiones.push(peticion);
            });
            ordenarPeticiones();
            actualizarPeticiones();
        });

        // Agregar una nueva petición a Firebase
        function agregarPeticion(event) {
            event.preventDefault();
            const solicitante = document.getElementById("solicitante").value;
            const solicitado = document.getElementById("solicitado").value;
            const descripcion = document.getElementById("descripcion").value;
            const fecha = document.getElementById("fecha").value;
            const ahora = new Date();
            const horaSalida = new Date(fecha);

            const nuevaPeticion = {
                solicitante,
                solicitado,
                descripcion,
                horaSolicitud: ahora.toISOString(),
                salida: horaSalida.toISOString(),
                estado: horaSalida > ahora ? "a-tiempo" : "retrasado",
                pausado: false,
                tiempoRestante: (horaSalida - ahora) / 1000,
                tiempoDetenido: 0,
                tiempoInicioPausa: 0,
                tiempoPausadoOriginal: 0
            };

            push(peticionesRef, nuevaPeticion); // Guardar en Firebase
            document.getElementById("form-peticion").reset();
        }

        function ordenarPeticiones() {
            peticiones.sort((a, b) => {
                if (a.estado === "retrasado" && b.estado !== "retrasado") return -1;
                if (b.estado === "retrasado" && a.estado !== "retrasado") return 1;
                if (a.estado === "a-tiempo" && b.estado !== "a-tiempo") return 1;
                if (b.estado === "a-tiempo" && a.estado !== "a-tiempo") return -1;
                if (a.estado === "retrasado" && b.estado === "retrasado") {
                    return b.tiempoDetenido - a.tiempoDetenido;
                }
                return a.tiempoRestante - b.tiempoRestante;
            });

            const pausadas = peticiones.filter(peticion => peticion.pausado);
            const noPausadas = peticiones.filter(peticion => !peticion.pausado);
            peticiones = [...noPausadas, ...pausadas];
        }

        function actualizarPeticiones() {
            const tabla = document.getElementById("tabla-peticiones");
            tabla.innerHTML = "";
            const ahora = new Date();

            peticiones.forEach(peticion => {
                const horaSalida = new Date(peticion.salida);
                let estado;
                if (peticion.pausado) {
                    estado = `<span class="${peticion.estado}">Pausado</span>`;
                } else {
                    const diferencia = (horaSalida - ahora) / 1000;
                    if (diferencia > 0) {
                        const horas = Math.floor(diferencia / 3600);
                        const minutos = Math.floor((diferencia % 3600) / 60);
                        estado = `<span class="a-tiempo">${horas}h ${minutos}m</span>`;
                    } else {
                        const retraso = Math.abs(diferencia);
                        const horas = Math.floor(retraso / 3600);
                        const minutos = Math.floor((retraso % 3600) / 60);
                        estado = `<span class="retrasado">${horas}h ${minutos}m</span>`;
                    }
                }

                const fila = `
                    <tr>
                        <td>${new Date(peticion.horaSolicitud).toLocaleString()}</td>
                        <td>${peticion.solicitante}</td>
                        <td>${peticion.solicitado}</td>
                        <td>${peticion.descripcion}</td>
                        <td>${horaSalida.toLocaleDateString()}</td>
                        <td>${horaSalida.toLocaleTimeString()}</td>
                        <td>${estado}</td>
                        <td><button onclick="pausarPeticion('${peticion.id}')">${peticion.pausado ? "Reanudar" : "Pausar"}</button></td>
                    </tr>
                `;
                tabla.innerHTML += fila;
            });
        }

        function pausarPeticion(id) {
            const peticion = peticiones.find(p => p.id === id);
            if (peticion) {
                peticion.pausado = !peticion.pausado;
                update(ref(db, `peticiones/${id}`), { pausado: peticion.pausado });
            }
        }

        setInterval(actualizarPeticiones, 1000);
    </script>
</head>
<body>
    <h1>Seguimiento Peticiones</h1>
    <div class="reloj">
        <span id="hora"></span>
    </div>
    <div class="fecha">
        <span id="fecha-hoy"></span>
    </div>
    <div class="form-container" id="formulario-peticion">
        <h2>Agregar</h2>
        <form id="form-peticion" onsubmit="agregarPeticion(event)">
            <label for="solicitante">Solicitante:</label>
            <input type="text" id="solicitante" required><br><br>
            <label for="solicitado">Solicitado:</label>
            <input type="text" id="solicitado" required><br><br>
            <label for="descripcion">Descripción:</label>
            <input type="text" id="descripcion" required><br><br>
            <label for="fecha">Fecha y Hora:</label>
            <input type="datetime-local" id="fecha" required><br><br>
            <button type="submit">Agregar</button>
        </form>
    </div>
    <table>
        <thead>
            <tr>
                <th>Hora y Día Solicitado</th>
                <th>Solicitante</th>
                <th>Solicitado</th>
                <th>Descripción</th>
                <th>Día Necesario</th>
                <th>Hora Necesaria</th>
                <th>Estado</th>
                <th>Pausar</th>
            </tr>
        </thead>
        <tbody id="tabla-peticiones"></tbody>
    </table>
</body>
</html>
