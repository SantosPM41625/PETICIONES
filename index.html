<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento Peticiones</title>
    <style>
        /* Tu estilo aquí */
    </style>
    <!-- Agregar el SDK de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js"></script>
</head>
<body>
    <h1>Seguimiento Peticiones</h1>
    
    <!-- Reloj y fecha -->
    <div class="reloj">
        <span id="hora"></span>
    </div>
    <div class="fecha">
        <span id="fecha-hoy"></span>
    </div>

    <!-- Formulario de entrada para peticiones (siempre visible) -->
    <div class="form-container" id="formulario-peticion">
        <h2>Agregar</h2>
        <form id="form-peticion" onsubmit="agregarPeticion(event)">
            <label for="solicitante">Solicitante:</label>
            <input type="text" id="solicitante" required><br><br>

            <label for="solicitado">Solicitado:</label>
            <input type="text" id="solicitado" required><br><br>

            <label for="descripcion">Descripción:</label>
            <input type="text" id="descripcion" required><br><br>

            <label for="fecha">Fecha y Hora:</label>
            <input type="datetime-local" id="fecha" required><br><br>

            <button type="submit">Agregar</button> <!-- El botón solo tiene el texto "Agregar" -->
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>Hora y Día Solicitado</th>
                <th>Solicitante</th>
                <th>Solicitado</th>
                <th>Descripción</th>
                <th>Día Necesario</th>
                <th>Hora Necesaria</th>
                <th>Estado</th>
                <th>Pausar</th>
            </tr>
        </thead>
        <tbody id="tabla-peticiones">
            <!-- Aquí se llenarán las peticiones dinámicamente -->
        </tbody>
    </table>

    <script>
        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB48xrH1QK8-6qd-YGo35v2Cg-gGuKUOOw",
            authDomain: "pm41625-e21b1.firebaseapp.com",
            databaseURL: "https://pm41625-e21b1-default-rtdb.firebaseio.com",
            projectId: "pm41625-e21b1",
            storageBucket: "pm41625-e21b1.firebasestorage.app",
            messagingSenderId: "959371187087",
            appId: "1:959371187087:web:2f04847d8e6010913731fa",
            measurementId: "G-CLEDJ8C6VG"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        // Función para agregar una petición en Firebase
        function agregarPeticion(event) {
            event.preventDefault(); // Evitar el envío del formulario

            const solicitante = document.getElementById("solicitante").value;
            const solicitado = document.getElementById("solicitado").value;
            const descripcion = document.getElementById("descripcion").value;
            const fecha = document.getElementById("fecha").value;
            const ahora = new Date();
            const horaSolicitud = new Date();
            const horaSalida = new Date(fecha);

            let estado = horaSalida > ahora ? "a-tiempo" : "retrasado";

            // Crear un ID único para la petición
            const nuevaPeticionRef = db.ref('peticiones').push();
            nuevaPeticionRef.set({
                solicitante: solicitante,
                solicitado: solicitado,
                descripcion: descripcion,
                horaSolicitud: horaSolicitud.toISOString(),
                salida: horaSalida.toISOString(),
                estado: estado,
                pausado: false,
                tiempoRestante: 0,
                tiempoDetenido: 0,
                tiempoInicioPausa: 0
            }).then(() => {
                console.log("Petición agregada correctamente.");
            }).catch((error) => {
                console.error("Error al agregar la petición: ", error);
            });

            // Limpiar campos del formulario
            document.getElementById("form-peticion").reset();
        }

        // Función para escuchar cambios en las peticiones en tiempo real
        function escucharPeticiones() {
            const peticionesRef = db.ref('peticiones');
            peticionesRef.on('value', (snapshot) => {
                const peticiones = snapshot.val();
                actualizarPeticiones(peticiones);
            });
        }

        // Función para actualizar la tabla de peticiones
        function actualizarPeticiones(peticiones) {
            const tabla = document.getElementById("tabla-peticiones");
            tabla.innerHTML = ""; // Limpiar la tabla

            const ahora = new Date();

            Object.keys(peticiones).forEach((key) => {
                const peticion = peticiones[key];
                const horaSalida = new Date(peticion.salida);
                let diferencia = (horaSalida - ahora) / 1000;

                if (horaSalida <= ahora) {
                    peticion.estado = "retrasado";
                } else {
                    peticion.estado = "a-tiempo";
                }

                let estado;
                if (peticion.pausado) {
                    const tiempoPausado = peticion.estado === "a-tiempo" ? peticion.tiempoRestante : peticion.tiempoDetenido;
                    const horas = Math.floor(tiempoPausado / 3600);
                    const minutos = Math.floor((tiempoPausado % 3600) / 60);
                    const segundos = Math.floor(tiempoPausado % 60);
                    estado = `<span class="${peticion.estado}">${horas}h ${minutos}m ${segundos}s</span>`;
                } else {
                    if (peticion.estado === "a-tiempo" && diferencia > 0) {
                        const horas = Math.floor(diferencia / 3600);
                        const minutos = Math.floor((diferencia % 3600) / 60);
                        const segundos = Math.floor(diferencia % 60);
                        estado = `<span class="a-tiempo">${horas}h ${minutos}m ${segundos}s</span>`;
                        peticion.tiempoRestante = diferencia;
                    } else if (peticion.estado === "retrasado") {
                        const retraso = Math.abs(diferencia);
                        const horas = Math.floor(retraso / 3600);
                        const minutos = Math.floor((retraso % 3600) / 60);
                        const segundos = Math.floor(retraso % 60);
                        estado = `<span class="retrasado">${horas}h ${minutos}m ${segundos}s</span>`;
                        peticion.tiempoDetenido = retraso;
                    }
                }

                const fila = `
                    <tr>
                        <td>${formatearFechaHora(peticion.horaSolicitud)}</td>
                        <td>${peticion.solicitante}</td>
                        <td>${peticion.solicitado}</td>
                        <td>${peticion.descripcion}</td>
                        <td>${horaSalida.toLocaleDateString()}</td>
                        <td>${horaSalida.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>
                        <td>${estado}</td>
                    </tr>
                `;
                tabla.innerHTML += fila;
            });
        }

        // Función para formatear la fecha y hora solicitada
        function formatearFechaHora(fecha) {
            const options = { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true };
            return new Date(fecha).toLocaleString('es-ES', options);
        }

        // Iniciar la escucha de cambios en tiempo real
        escucharPeticiones();

        // Función para actualizar la hora y fecha actual
        function actualizarReloj() {
            const ahora = new Date();
            document.getElementById('hora').textContent = ahora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            document.getElementById('fecha-hoy').textContent = `${new Intl.DateTimeFormat('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(ahora)}`;
        }

        setInterval(actualizarReloj, 1000);
        actualizarReloj(); // Ejecutar una vez al inicio
    </script>
</body>
</html>
