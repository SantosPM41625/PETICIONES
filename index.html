<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento Peticiones</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        table {
            width: 90%;
            margin: 0 auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        th {
            background-color: #f4f4f4;
        }
        .retrasado {
            color: red;
            font-weight: bold;
        }
        .a-tiempo {
            color: green;
        }
        .form-container {
            margin-bottom: 20px;
        }
        .reloj {
            font-size: 40px;
            font-weight: bold;
        }
        .fecha {
            font-size: 18px;
            margin-top: 5px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Seguimiento Peticiones</h1>
    
    <!-- Reloj y fecha -->
    <div class="reloj">
        <span id="hora"></span>
    </div>
    <div class="fecha">
        <span id="fecha-hoy"></span>
    </div>

    <!-- Formulario de entrada para peticiones -->
    <div class="form-container" id="formulario-peticion">
        <h2>Agregar</h2>
        <form id="form-peticion" onsubmit="agregarPeticion(event)">
            <label for="solicitante">Solicitante:</label>
            <input type="text" id="solicitante" required><br><br>

            <label for="solicitado">Solicitado:</label>
            <input type="text" id="solicitado" required><br><br>

            <label for="descripcion">Descripción:</label>
            <input type="text" id="descripcion" required><br><br>

            <label for="fecha">Fecha y Hora:</label>
            <input type="datetime-local" id="fecha" required><br><br>

            <button type="submit">Agregar</button>
        </form>
    </div>

    <!-- Cargar archivo Excel -->
    <input type="file" id="file-input" accept=".xlsx" />

    <!-- Botón para guardar como Excel -->
    <button onclick="guardarComoExcel()">Guardar como Excel</button>

    <table>
        <thead>
            <tr>
                <th>Hora y Día Solicitado</th>
                <th>Solicitante</th>
                <th>Solicitado</th>
                <th>Descripción</th>
                <th>Día Necesario</th>
                <th>Hora Necesaria</th>
                <th>Estado</th>
                <th>Pausar</th>
            </tr>
        </thead>
        <tbody id="tabla-peticiones">
        </tbody>
    </table>

    <script>
        let peticiones = [];

        // Guardar en localStorage
        function guardarEnLocalStorage() {
            localStorage.setItem('peticiones', JSON.stringify(peticiones));
        }

        // Cargar desde localStorage
        function cargarDesdeLocalStorage() {
            const datosGuardados = localStorage.getItem('peticiones');
            if (datosGuardados) {
                peticiones = JSON.parse(datosGuardados);
                peticiones.forEach(peticion => {
                    peticion.horaSolicitud = new Date(peticion.horaSolicitud);
                    peticion.salida = new Date(peticion.salida);
                });
                ordenarPeticiones();
                actualizarPeticiones();
            }
        }

        // Leer el archivo Excel cargado
        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                peticiones = jsonData.map(peticion => ({
                    ...peticion,
                    horaSolicitud: new Date(peticion.horaSolicitud),
                    salida: new Date(peticion.salida),
                    tiempoRestante: (new Date(peticion.salida) - new Date()) / 1000,
                    tiempoDetenido: peticion.tiempoDetenido || 0,
                    pausado: peticion.pausado || false,
                    tiempoPausadoOriginal: peticion.tiempoPausadoOriginal || 0
                }));
                ordenarPeticiones();
                actualizarPeticiones();
                guardarEnLocalStorage();
            };
            reader.readAsBinaryString(file);
        });

        function agregarPeticion(event) {
            event.preventDefault();
            const solicitante = document.getElementById("solicitante").value;
            const solicitado = document.getElementById("solicitado").value;
            const descripcion = document.getElementById("descripcion").value;
            const fecha = document.getElementById("fecha").value;
            const horaSolicitud = new Date();
            const horaSalida = new Date(fecha);

            let estado = horaSalida > new Date() ? "a-tiempo" : "retrasado";

            peticiones.push({
                solicitante,
                solicitado,
                descripcion,
                horaSolicitud,
                salida: horaSalida.toISOString(),
                estado,
                pausado: false,
                tiempoRestante: (horaSalida - new Date()) / 1000,
                tiempoDetenido: 0,
                tiempoInicioPausa: 0,
                tiempoPausadoOriginal: 0,
            });

            ordenarPeticiones();
            document.getElementById("form-peticion").reset();
            actualizarPeticiones();
            guardarEnLocalStorage();
        }

        function actualizarReloj() {
            const ahora = new Date();
            document.getElementById("hora").textContent = ahora.toLocaleTimeString();
            document.getElementById("fecha-hoy").textContent = ahora.toLocaleDateString();
        }

        setInterval(actualizarReloj, 1000);

        // Inicializar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarDesdeLocalStorage();
            actualizarReloj();
        });
    </script>
</body>
</html>
