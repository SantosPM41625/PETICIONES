<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peticiones PM</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDQO2TmV4PdDy51VLQtupOlKkVN0jGCXBI",
            authDomain: "santos-b9a94.firebaseapp.com",
            databaseURL: "https://santos-b9a94-default-rtdb.firebaseio.com",
            projectId: "santos-b9a94",
            storageBucket: "santos-b9a94.firebasestorage.app",
            messagingSenderId: "492660727320",
            appId: "1:492660727320:web:9a6e4c09c218a5bed22d6d",
            measurementId: "G-WK07Q4KDDH"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Función para agregar una petición
        function agregarPeticion(event) {
            event.preventDefault();
            const solicitante = document.getElementById("solicitante").value;
            const solicitado = document.getElementById("solicitado").value;
            const descripcion = document.getElementById("descripcion").value;
            const fecha = document.getElementById("fecha").value;
            const horaSolicitud = new Date();
            const horaSalida = new Date(fecha);

            let estado = horaSalida > new Date() ? "a-tiempo" : "retrasado";

            const nuevaPeticion = {
                solicitante,
                solicitado,
                descripcion,
                horaSolicitud: horaSolicitud.toISOString(),
                salida: horaSalida.toISOString(),
                estado,
                pausado: false,
                tiempoRestante: (horaSalida - new Date()) / 1000, // Tiempo restante en segundos
                tiempoDetenido: 0,
                tiempoInicioPausa: 0,
                tiempoPausadoOriginal: 0,
            };

            // Guardar la petición en Firebase
            const peticionesRef = ref(database, 'peticiones');
            const nuevaPeticionRef = ref(peticionesRef);
            set(nuevaPeticionRef, nuevaPeticion);

            actualizarPeticiones();
            document.getElementById("form-peticion").reset();
        }

        // Función para actualizar las peticiones desde Firebase
        function actualizarPeticiones() {
            const tabla = document.getElementById("tabla-peticiones");
            tabla.innerHTML = "";

            const peticionesRef = ref(database, 'peticiones');
            onValue(peticionesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(peticion => {
                        const horaSalida = new Date(peticion.salida);
                        const ahora = new Date();
                        let diferencia = (horaSalida - ahora) / 1000; // Calcular diferencia en segundos

                        let estado;
                        if (peticion.pausado) {
                            const tiempoPausado = peticion.tiempoPausadoOriginal ? peticion.tiempoPausadoOriginal : peticion.tiempoRestante;
                            const horas = Math.floor(tiempoPausado / 3600);
                            const minutos = Math.floor((tiempoPausado % 3600) / 60);
                            const segundos = Math.floor(tiempoPausado % 60);
                            estado = `<span class="${peticion.estado}">${horas}h ${minutos}m ${segundos}s</span>`;
                        } else {
                            if (peticion.estado === "a-tiempo" && diferencia > 0) {
                                const horas = Math.floor(diferencia / 3600);
                                const minutos = Math.floor((diferencia % 3600) / 60);
                                const segundos = Math.floor(diferencia % 60);
                                estado = `<span class="a-tiempo">${horas}h ${minutos}m ${segundos}s</span>`;
                                peticion.tiempoRestante = diferencia;
                            } else if (peticion.estado === "retrasado") {
                                const retraso = Math.abs(diferencia);
                                const horas = Math.floor(retraso / 3600);
                                const minutos = Math.floor((retraso % 3600) / 60);
                                const segundos = Math.floor(retraso % 60);
                                estado = `<span class="retrasado">${horas}h ${minutos}m ${segundos}s</span>`;
                                peticion.tiempoDetenido = retraso;
                            }
                        }

                        const fila = `
                            <tr>
                                <td>${formatearFechaHora(peticion.horaSolicitud)}</td>
                                <td>${peticion.solicitante}</td>
                                <td>${peticion.solicitado}</td>
                                <td>${peticion.descripcion}</td>
                                <td>${horaSalida.toLocaleDateString()}</td>
                                <td>${horaSalida.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>
                                <td>${estado}</td>
                            </tr>
                        `;
                        tabla.innerHTML += fila;
                    });
                }
            });
        }

        function formatearFechaHora(fecha) {
            const options = { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true };
            return new Date(fecha).toLocaleString('es-ES', options);
        }

        setInterval(actualizarPeticiones, 1000);
    </script>
</head>
<body>
    <h1 style="color: #324a9a;">Seguimiento Peticiones</h1>

    <div class="form-container" id="formulario-peticion">
        <h2></h2>
        <form id="form-peticion" onsubmit="agregarPeticion(event)">
            <label for="solicitante">Solicitante:</label>
            <input type="text" id="solicitante" required><br><br>

            <label for="solicitado">Solicitado:</label>
            <input type="text" id="solicitado" required><br><br>

            <label for="descripcion">Descripción:</label>
            <input type="text" id="descripcion" required><br><br>

            <label for="fecha">Fecha y Hora:</label>
            <input type="datetime-local" id="fecha" required><br><br>

            <button type="submit" style="font-size: 15px; padding: 5px 50px;">Agregar</button>
        </form>
    </div>
    
    <!-- Tabla general de peticiones -->
    <table>
        <thead>
            <tr>
                <th>Hora y Día Solicitado</th>
                <th>Solicitante</th>
                <th>Solicitado</th>
                <th>Descripción</th>
                <th>Día Necesario</th>
                <th>Hora Necesaria</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="tabla-peticiones">
        </tbody>
    </table>
</body>
</html>
